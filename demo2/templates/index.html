<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>农产品价格查询</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .container {
            margin-top: 30px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-control, .form-select {
            border-radius: 5px;
        }
        .btn-primary, .btn-success {
            border-radius: 5px;
        }
        .table-responsive {
            margin-top: 30px;
            /* 调试样式：添加一个明显的边框 */
            border: 2px solid transparent; /* 默认透明 */
        }
        /* 调试用活动边框 */
        .table-responsive.debug-active-border {
            border: 2px solid red !important; /* 激活时显示红色边框 */
        }

        .table thead {
            background-color: #007bff;
            color: white;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .spinner-border {
            display: none; /* 默认隐藏 */
            margin-left: 10px;
        }

        /* 地图和折线图容器样式 */
        #chinaMapContainer, #priceLineChartContainer {
            width: 100%;
            margin-top: 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* 默认隐藏 */
        }
        #chinaMapContainer {
            height: 700px; /* 地图高度调整为700px，更大 */
        }
        #priceLineChartContainer {
            height: 400px; /* 折线图高度保持不变 */
        }

        /* 新增样式 */
        .price-up {
            color: red;
            font-weight: bold;
        }
        .price-down {
            color: green;
            font-weight: bold;
        }
        .price-neutral {
            color: #333; /* 默认颜色 */
        }
        .arrow {
            font-size: 1.2em; /* 箭头大小 */
            vertical-align: middle;
            margin-left: 5px;
        }
        /* 状态消息样式 */
        #statusMessage {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none; /* 默认隐藏 */
        }
        #statusMessage.alert-info {
            background-color: #e2f4ff;
            color: #007bff;
            border: 1px solid #b8daff;
        }
        #statusMessage.alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #statusMessage.alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>农产品价格查询与分析</h1>

        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-3">
                <label for="vegetableSelect" class="form-label">选择蔬菜:</label>
                <select class="form-select" id="vegetableSelect">
                    </select>
            </div>
            <div class="col-md-3">
                <label for="regionSelect" class="form-label">选择地区:</label>
                <select class="form-select" id="regionSelect">
                    <option value="all" selected>所有地区</option> </select>
            </div>
            <div class="col-md-3">
                <label for="marketSelect" class="form-label">选择市场:</label>
                <select class="form-select" id="marketSelect">
                    <option value="all" selected>所有市场</option> </select>
            </div>
            <div class="col-md-3">
                <label for="daysSelect" class="form-label">最近天数:</label>
                <select class="form-select" id="daysSelect">
                    <option value="7" selected>最近7天</option>
                    <option value="30">最近30天</option>
                    <option value="90">最近90天</option>
                    <option value="365">最近1年</option>
                    <option value="custom">自定义日期</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="startDate" class="form-label">开始日期:</label>
                <input type="date" class="form-control" id="startDate" disabled>
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">结束日期:</label>
                <input type="date" class="form-control" id="endDate" disabled>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary w-100" id="queryBtn">
                    查询
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-success w-100" id="exportBtn">
                    导出CSV
                </button>
            </div>
        </div>

        <div id="statusMessage" class="alert"></div>

        <div id="chinaMapContainer"></div>
        <div id="priceLineChartContainer"></div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>蔬菜</th>
                        <th>地区</th>
                        <th>市场</th>
                        <th>价格(元/公斤)</th>
                        <th>涨跌(%)</th>
                        <th>日期</th>
                    </tr>
                </thead>
                <tbody id="priceTableBody">
                    <tr><td colspan="6" class="text-center">请点击查询按钮加载数据</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const vegetableSelect = document.getElementById('vegetableSelect');
        const regionSelect = document.getElementById('regionSelect');
        const marketSelect = document.getElementById('marketSelect');
        const daysSelect = document.getElementById('daysSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const queryBtn = document.getElementById('queryBtn');
        const exportBtn = document.getElementById('exportBtn');
        const priceTableBody = document.getElementById('priceTableBody');
        const querySpinner = queryBtn.querySelector('.spinner-border');
        const chinaMapContainer = document.getElementById('chinaMapContainer');
        const priceLineChartContainer = document.getElementById('priceLineChartContainer');
        const statusMessageDiv = document.getElementById('statusMessage'); // 新增状态消息DOM

        let myChart = null; // ECharts 实例 (地图)
        let lineChart = null; // ECharts 实例 (折线图)

        // --- 辅助函数：更新状态消息 ---
        function updateStatusMessage(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `alert alert-${type}`; // bootstrap alert class
            statusMessageDiv.style.display = 'block';
            console.log(`[STATUS] ${type.toUpperCase()}: ${message}`);
        }

        // --- 辅助函数：隐藏状态消息 ---
        function hideStatusMessage() {
            statusMessageDiv.style.display = 'none';
            statusMessageDiv.textContent = '';
            statusMessageDiv.className = 'alert';
        }

        // --- 初始化日期输入框 ---
        function setInitialDates() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = sevenDaysAgo.toISOString().split('T')[0];
        }

        // --- 加载下拉菜单数据 ---
        async function loadSelectOptions() {
            updateStatusMessage('正在加载筛选条件...', 'info');
            try {
                // 加载蔬菜
                const vegResponse = await fetch('/api/vegetables');
                const vegData = await vegResponse.json();
                if (vegData.vegetables && vegData.vegetables.length > 0) {
                    vegetableSelect.innerHTML = ''; // 清空现有选项
                    vegData.vegetables.forEach(veg => {
                        const option = document.createElement('option');
                        option.value = veg;
                        option.textContent = veg;
                        vegetableSelect.appendChild(option);
                    });
                } else {
                    vegetableSelect.innerHTML = '<option value="">无蔬菜数据</option>';
                    console.warn("API '/api/vegetables' 返回空或无效数据。");
                }

                // 加载地区
                const regResponse = await fetch('/api/regions');
                const regData = await regResponse.json();
                if (regData.regions) {
                    regionSelect.innerHTML = '<option value="all">所有地区</option>'; // 清空并添加默认选项
                    regData.regions.forEach(reg => {
                        const option = document.createElement('option');
                        option.value = reg;
                        option.textContent = reg;
                        regionSelect.appendChild(option);
                    });
                    // 地区加载完成后，根据默认选择的地区加载市场
                    loadMarketsByRegion(regionSelect.value);
                } else {
                    console.warn("API '/api/regions' 返回空或无效数据。");
                }
                updateStatusMessage('筛选条件加载完成。', 'success');

            } catch (error) {
                console.error('加载下拉菜单选项失败:', error);
                updateStatusMessage('加载筛选条件失败，请检查后端服务是否运行。', 'danger');
                alert('加载筛选条件失败，请检查后端服务。');
            }
        }

        // --- 根据地区加载市场 ---
        async function loadMarketsByRegion(selectedRegion) {
            marketSelect.innerHTML = '<option value="all">所有市场</option>'; // 清空并添加默认选项
            if (selectedRegion === 'all') {
                return; // 如果选择了“所有地区”，则不加载具体市场
            }
            try {
                const marketResponse = await fetch(`/api/markets?region=${encodeURIComponent(selectedRegion)}`);
                const marketData = await marketResponse.json();
                if (marketData.markets) {
                    marketData.markets.forEach(market => {
                        const option = document.createElement('option');
                        option.value = market;
                        option.textContent = market;
                        marketSelect.appendChild(option);
                    });
                } else {
                    console.warn(`API '/api/markets?region=${selectedRegion}' 返回空或无效数据。`);
                }
            } catch (error) {
                console.error('加载市场选项失败:', error);
                // 这里不弹出 alert，因为市场加载失败不影响主查询功能，只影响下拉菜单
            }
        }

        // --- 查询价格数据并更新表格 / 渲染地图 / 渲染折线图 ---
        async function queryPrices() {
            queryBtn.disabled = true;
            querySpinner.style.display = 'inline-block';
            hideStatusMessage(); // 隐藏之前的状态消息

            // 每次查询前，先隐藏所有可视化区域并移除表格的调试边框
            chinaMapContainer.style.display = 'none';
            priceLineChartContainer.style.display = 'none';
            const tableResponsive = priceTableBody.closest('.table-responsive');
            tableResponsive.style.display = 'none';
            tableResponsive.classList.remove('debug-active-border'); // 移除调试边框

            priceTableBody.innerHTML = '<tr><td colspan="6" class="text-center">正在加载数据...</td></tr>'; // 提示加载中

            const selectedVegetable = vegetableSelect.value;
            const selectedRegion = regionSelect.value;
            const selectedMarket = marketSelect.value;
            const selectedDays = daysSelect.value;

            let startDate = '';
            let endDate = '';

            if (selectedDays === 'custom') {
                startDate = startDateInput.value;
                endDate = endDateInput.value;
            } else {
                const today = new Date();
                endDate = today.toISOString().split('T')[0];
                const pastDate = new Date(today);
                pastDate.setDate(today.getDate() - parseInt(selectedDays));
                startDate = pastDate.toISOString().split('T')[0];
            }

            console.log(`[QUERY] 查询参数: 蔬菜=${selectedVegetable}, 地区=${selectedRegion}, 市场=${selectedMarket}, 开始日期=${startDate}, 结束日期=${endDate}`);

            // 如果未选择蔬菜，则直接提示并退出
            if (selectedVegetable === '') {
                console.log("[QUERY_FLOW] 未选择蔬菜，显示表格提示。");
                tableResponsive.style.display = 'block'; // **确保显示表格**
                tableResponsive.classList.add('debug-active-border'); // **添加调试边框**
                priceTableBody.innerHTML = '<tr><td colspan="6" class="text-center">请选择一种蔬菜进行查询。</td></tr>';
                updateStatusMessage('请选择一种蔬菜进行查询。', 'info');
                queryBtn.disabled = false;
                querySpinner.style.display = 'none';
                return;
            }

            // ====================================================================
            // 改变后的核心逻辑：不再是 if-else 互斥，而是根据条件独立显示图表和表格
            // ====================================================================

            // 1. 获取地图数据并渲染（如果条件满足）
            const shouldRenderMap = (selectedVegetable !== '' && selectedRegion === 'all' && selectedMarket === 'all');
            if (shouldRenderMap) {
                console.log("[QUERY_FLOW] 尝试显示地图。");
                const queryParamsMap = new URLSearchParams({
                    vegetable: selectedVegetable,
                    startDate: startDate,
                    endDate: endDate
                });
                if (selectedDays !== 'custom') {
                    queryParamsMap.append('days', selectedDays);
                }

                try {
                    updateStatusMessage('正在加载地图数据...', 'info');
                    const responseMap = await fetch(`/api/average_prices_by_region?${queryParamsMap.toString()}`);
                    const dataMap = await responseMap.json();
                    console.log("[API_RESPONSE_MAP]", dataMap);

                    if (dataMap.error) {
                        console.error("[MAP_ERROR] 后端返回错误 (地图):", dataMap.error);
                        // 即使地图出错，也要继续尝试加载表格数据
                        updateStatusMessage(`加载地图数据失败: ${dataMap.error}`, 'danger');
                    } else if (dataMap.average_prices && dataMap.average_prices.length > 0) {
                        console.log("[MAP_SUCCESS] 成功获取地图数据。");
                        chinaMapContainer.style.display = 'block'; // 显示地图
                        renderChinaMap(dataMap.average_prices);
                        if (myChart) {
                            myChart.resize();
                        }
                        updateStatusMessage('已在地图上展示地区平均价格。', 'success');
                    } else {
                        console.warn("[MAP_NO_DATA] 没有找到符合条件的地区平均价格数据。");
                        updateStatusMessage('没有找到符合条件的地区平均价格数据。', 'info');
                    }
                } catch (error) {
                    console.error('[MAP_NETWORK_ERROR] 请求地图数据失败:', error);
                    updateStatusMessage(`网络请求失败 (地图): ${error.message || error}`, 'danger');
                }
            }

            // 2. 获取价格数据并渲染折线图和表格（总是尝试）
            const queryParamsPrices = new URLSearchParams({
                vegetable: selectedVegetable,
                region: selectedRegion,
                market: selectedMarket,
                startDate: startDate,
                endDate: endDate
            });
            if (selectedDays !== 'custom') {
                queryParamsPrices.append('days', selectedDays);
            }

            try {
                updateStatusMessage('正在加载价格详情数据...', 'info'); // 更新状态消息
                const responsePrices = await fetch(`/api/prices?${queryParamsPrices.toString()}`);
                const dataPrices = await responsePrices.json();
                console.log("[API_RESPONSE_PRICES]", dataPrices);

                if (dataPrices.error) {
                    console.error("[PRICES_ERROR] 后端返回错误:", dataPrices.error);
                    tableResponsive.style.display = 'block'; // **确保显示表格**
                    tableResponsive.classList.add('debug-active-border'); // **添加调试边框**
                    priceTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">加载数据失败: ${dataPrices.error}</td></tr>`;
                    updateStatusMessage(`加载数据失败: ${dataPrices.error}`, 'danger');
                } else if (dataPrices.prices && dataPrices.prices.length > 0) {
                    // 渲染折线图（如果条件满足）
                    const shouldRenderLineChart = (selectedVegetable !== '' && selectedRegion !== 'all');
                    if (shouldRenderLineChart) {
                        console.log("[LINE_CHART_SUCCESS] 成功获取折线图数据。");
                        priceLineChartContainer.style.display = 'block'; // 显示折线图
                        renderLineChart(dataPrices.prices, selectedMarket);
                        updateStatusMessage('已在折线图上展示价格趋势。', 'success');
                    }

                    // 总是渲染表格实际数据
                    console.log("[TABLE_SUCCESS] 成功获取表格数据，渲染表格。");
                    tableResponsive.style.display = 'block'; // **确保显示表格**
                    tableResponsive.classList.add('debug-active-border'); // **添加调试边框**
                    priceTableBody.innerHTML = ''; // 清空旧数据
                    dataPrices.prices.forEach(item => {
                        const row = priceTableBody.insertRow();
                        row.insertCell().textContent = item.vegetable;
                        row.insertCell().textContent = item.region;
                        row.insertCell().textContent = item.market;
                        row.insertCell().textContent = item.price.toFixed(2); // 格式化价格

                        const changeCell = row.insertCell();
                        const changeValue = item.change;
                        const changeText = changeValue.toFixed(2);

                        let className = 'price-neutral';
                        let arrowHtml = '';

                        if (changeValue < 0) { // 负数表示上涨 (根据原代码逻辑)
                            className = 'price-up';
                            arrowHtml = ' <span class="arrow">&#x2191;</span>'; // 向上箭头
                        } else if (changeValue > 0) { // 正数表示下降 (根据原代码逻辑)
                            className = 'price-down';
                            arrowHtml = ' <span class="arrow">&#x2193;</span>'; // 向下箭头
                        }
                        changeCell.innerHTML = `<span class="${className}">${changeText}%${arrowHtml}</span>`;
                        row.insertCell().textContent = item.date;
                    });
                    updateStatusMessage('已在表格中显示价格数据。', 'success'); // 确保显示表格成功状态
                } else {
                    console.warn("[PRICES_NO_DATA] 没有找到符合条件的价格详情数据。");
                    tableResponsive.style.display = 'block'; // **确保显示表格**
                    tableResponsive.classList.add('debug-active-border'); // **添加调试边框**
                    priceTableBody.innerHTML = '<tr><td colspan="6" class="text-center">没有找到符合条件的数据。</td></tr>';
                    updateStatusMessage('没有找到符合条件的价格详情数据。', 'info');
                }
            } catch (error) {
                console.error('[PRICES_NETWORK_ERROR] 请求价格详情数据失败:', error);
                tableResponsive.style.display = 'block'; // **确保显示表格**
                tableResponsive.classList.add('debug-active-border'); // **添加调试边框**
                priceTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">网络请求失败: ${error}</td></tr>`;
                updateStatusMessage(`网络请求失败: ${error.message || error}`, 'danger');
            } finally {
                queryBtn.disabled = false;
                querySpinner.style.display = 'none';
            }
        }

        // --- 渲染中国地图 (ECharts) ---
        async function renderChinaMap(averagePricesData) {
            if (!myChart) {
                myChart = echarts.init(chinaMapContainer);
            } else {
                myChart.clear(); // 每次渲染前清空，解决高亮不消失问题
            }

            const chinaGeoJsonUrl = '/static/geojson/China.json';

            try {
                const response = await fetch(chinaGeoJsonUrl);
                const chinaJson = await response.json();

                echarts.registerMap('china', chinaJson);

                const seriesData = averagePricesData.map(item => {
                    return {
                        name: item.region,
                        value: item.average_price
                    };
                });

                const prices = seriesData.map(item => item.value);
                // 确保 minPrice 和 maxPrice 有效，避免空数组 Math.min/max 错误
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 10;

                const option = {
                    title: {
                        text: `${vegetableSelect.value} 各地区平均价格`,
                        subtext: `日期范围: ${startDateInput.value} - ${endDateInput.value}`,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function (params) {
                            // 确保 params.value 存在，如果该地区无数据则显示“暂无数据”
                            if (params.value !== null && typeof params.value !== 'undefined') {
                                return `${params.name}: ${params.value.toFixed(2)} 元/公斤`;
                            } else {
                                return `${params.name}: 暂无数据`;
                            }
                        }
                    },
                    visualMap: {
                        min: minPrice,
                        max: maxPrice,
                        left: '20px',
                        top: 'center',
                        text: ['高', '低'],
                        calculable: true,
                        inRange: {
                            color: ['#e0ffff', '#006edd']
                        }
                    },
                    series: [
                        {
                            name: '平均价格',
                            type: 'map',
                            map: 'china',
                            roam: false,
                            center: [104.0, 35.0], // 设置地图中心点，确保居中
                            zoom: 1.2, // 初始缩放比例，可以根据需要调整
                            label: {
                                show: true,
                                color: '#333'
                            },
                            itemStyle: {
                                borderColor: '#fff'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#eee'
                                },
                                itemStyle: {
                                    areaColor: '#ffd700'
                                }
                            },
                            data: seriesData
                        }
                    ]
                };

                myChart.setOption(option);
                myChart.resize();

                // --- 添加地图点击事件监听器 ---
                myChart.off('click'); // 移除旧的点击事件，防止重复绑定
                myChart.on('click', function (params) {
                    if (params.componentType === 'series' && params.seriesType === 'map') {
                        const clickedRegionName = params.name; // 获取点击的地区名称
                        console.log(`[MAP_CLICK] 点击地区: ${clickedRegionName}`);
                        regionSelect.value = clickedRegionName; // 设置地区下拉表单的值
                        regionSelect.dispatchEvent(new Event('change')); // 触发 change 事件以加载市场

                        marketSelect.value = 'all'; // 将市场下拉表单重置为“所有市场”

                        queryPrices(); // 触发新的查询
                    }
                });

            } catch (error) {
                console.error('加载中国地图数据或渲染失败:', error);
                updateStatusMessage('无法加载或渲染中国地图，请检查本地GeoJSON文件和后端服务。', 'danger');
                alert('无法加载或渲染中国地图，请检查本地GeoJSON文件路径和内容，或地区名称是否与地图数据匹配。');
            }
        }

        // --- 渲染折线图 (ECharts) ---
        function renderLineChart(pricesData, selectedMarketFilter) {
            if (!lineChart) {
                lineChart = echarts.init(priceLineChartContainer);
            } else {
                lineChart.clear();
            }

            const dates = Array.from(new Set(pricesData.map(item => item.date))).sort();
            const markets = Array.from(new Set(pricesData.map(item => item.market)));

            const series = [];
            markets.forEach(market => {
                const marketData = dates.map(date => {
                    const priceEntry = pricesData.find(p => p.date === date && p.market === market);
                    return priceEntry ? priceEntry.price : null; // 使用 null 表示缺失数据点
                });

                series.push({
                    name: market,
                    type: 'line',
                    smooth: true,
                    data: marketData
                });
            });

            const option = {
                title: {
                    text: `${vegetableSelect.value} 在 ${regionSelect.value} 的价格趋势`,
                    subtext: `日期范围: ${startDateInput.value} - ${endDateInput.value}`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let tooltipContent = '';

                        if (params.length > 0) {
                            tooltipContent += `日期: ${params[0].name}<br/>`; // 显示日期 (X轴值)

                            params.forEach(item => {
                                // 确保 item、item.series 存在且 item.value 有效
                                if (item && item.series && item.value !== null && typeof item.value !== 'undefined') {
                                    // 显示每个市场的数据：颜色小方块、市场名称、价格
                                    tooltipContent += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>${item.seriesName}: ${item.value.toFixed(2)} 元/公斤<br/>`;
                                }
                            });
                        }

                        if (tooltipContent === '') {
                            return '无数据可显示';
                        }
                        return tooltipContent;
                    }
                },
                legend: {
                    data: markets,
                    type: 'scroll', // 当市场数量多时可滚动
                    top: 'bottom' // 图例放底部
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%', // 调整底部以容纳图例
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    name: '价格 (元/公斤)'
                },
                series: series
            };

            lineChart.setOption(option);
            lineChart.resize();
        }


        // --- 事件监听器 ---
        regionSelect.addEventListener('change', (event) => {
            console.log("[EVENT] 地区选择改变:", event.target.value);
            loadMarketsByRegion(event.target.value);
            queryPrices(); // 触发查询，因为筛选条件变了
        });

        marketSelect.addEventListener('change', () => {
            console.log("[EVENT] 市场选择改变:", marketSelect.value);
            queryPrices(); // 市场选择改变时也触发查询
        });

        daysSelect.addEventListener('change', (event) => {
            console.log("[EVENT] 最近天数选择改变:", event.target.value);
            const isCustom = event.target.value === 'custom';
            startDateInput.disabled = !isCustom;
            endDateInput.disabled = !isCustom;
            if (!isCustom) {
                setInitialDates(); // 如果切换回预设天数，重置日期输入框
            }
        });

        queryBtn.addEventListener('click', () => {
            console.log("[EVENT] 查询按钮点击。");
            queryPrices();
        });

        exportBtn.addEventListener('click', () => {
            console.log("[EVENT] 导出CSV按钮点击。");
            const selectedVegetable = vegetableSelect.value;
            const selectedRegion = regionSelect.value;
            const selectedMarket = marketSelect.value;
            const selectedDays = daysSelect.value;

            let startDate = '';
            let endDate = '';

            if (selectedDays === 'custom') {
                startDate = startDateInput.value;
                endDate = endDateInput.value;
            } else {
                const today = new Date();
                endDate = today.toISOString().split('T')[0];
                const pastDate = new Date(today);
                pastDate.setDate(today.getDate() - parseInt(selectedDays));
                startDate = pastDate.toISOString().split('T')[0];
            }

            const queryParams = new URLSearchParams({
                vegetable: selectedVegetable,
                region: selectedRegion,
                market: selectedMarket,
                startDate: startDate,
                endDate: endDate
            });
            if (selectedDays !== 'custom') {
                 queryParams.append('days', selectedDays);
            }

            // 直接跳转到导出URL，浏览器会处理下载
            window.location.href = `/api/export?${queryParams.toString()}`;
        });

        // --- 页面加载时执行 ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[INIT] 页面加载完成，初始化。");
            setInitialDates(); // 初始化日期输入框
            loadSelectOptions(); // 加载下拉菜单数据

            // 延迟执行查询，确保下拉菜单已填充且浏览器有时间渲染
            setTimeout(() => {
                queryPrices();
                console.log("[INIT] 首次查询已触发。");
            }, 500);
        });
    </script>
</body>
</html>